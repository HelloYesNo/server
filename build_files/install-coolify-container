#!/bin/bash
set -euo pipefail

echo "=== Coolify Container Installation Script ==="
echo "This script installs Coolify inside the distrobox container."
echo ""

# Check if already installed
if [ -f /var/lib/coolify/.installed ]; then
    echo "Coolify is already installed."
    echo "To reinstall, remove the marker file: rm /var/lib/coolify/.installed"
    exit 0
fi

# Check if Docker is available
if ! command -v docker >/dev/null 2>&1; then
    echo "ERROR: Docker is not available inside the container."
    echo "The distrobox container should have Docker installed via init_hook."
    echo "Try recreating the container: distrobox rm coolify && distrobox create coolify"
    exit 1
fi

# Check Docker socket access
if [ ! -S /var/run/docker.sock ]; then
    echo "ERROR: Docker socket not found at /var/run/docker.sock"
    echo "The container should share the host Docker socket."
    exit 1
fi

echo "Step 1: Creating directories in shared volume..."
mkdir -p /var/lib/coolify/{source,applications,databases,backups,services,proxy/dynamic,sentinel}

echo "Step 2: Downloading latest Coolify assets..."
curl -fsSL -L https://cdn.coollabs.io/coolify/docker-compose.yml -o /var/lib/coolify/source/docker-compose.yml
curl -fsSL -L https://cdn.coollabs.io/coolify/docker-compose.prod.yml -o /var/lib/coolify/source/docker-compose.prod.yml
curl -fsSL -L https://cdn.coollabs.io/coolify/.env.production -o /var/lib/coolify/source/.env.production
curl -fsSL -L https://cdn.coollabs.io/coolify/upgrade.sh -o /var/lib/coolify/source/upgrade.sh
chmod +x /var/lib/coolify/source/upgrade.sh

echo "Step 3: Generating secure secrets..."
ENV_FILE="/var/lib/coolify/source/.env"
cp /var/lib/coolify/source/.env.production "$ENV_FILE"

openssl rand -hex 16 > /tmp/app_id
openssl rand -base64 32 > /tmp/app_key
openssl rand -base64 32 > /tmp/db_password
openssl rand -base64 32 > /tmp/redis_password

sed -i "s|^APP_ID=.*|APP_ID=$(cat /tmp/app_id)|" "$ENV_FILE"
sed -i "s|^APP_KEY=.*|APP_KEY=base64:$(cat /tmp/app_key)|" "$ENV_FILE"
sed -i "s|^DB_PASSWORD=.*|DB_PASSWORD=$(cat /tmp/db_password)|" "$ENV_FILE"
sed -i "s|^REDIS_PASSWORD=.*|REDIS_PASSWORD=$(cat /tmp/redis_password)|" "$ENV_FILE"

rm -f /tmp/app_id /tmp/app_key /tmp/db_password /tmp/redis_password

echo "Step 4: Setting correct permissions..."
chown -R 9999:root /var/lib/coolify
chmod -R 700 /var/lib/coolify

echo "Step 5: Creating Coolify Docker network..."
if ! docker network inspect coolify >/dev/null 2>&1; then
    if ! docker network create --attachable --ipv6 coolify 2>/dev/null; then
        echo "Failed to create coolify network with ipv6. Trying without ipv6..."
        docker network create --attachable coolify 2>/dev/null
    fi
fi

echo "Step 6: Starting Coolify containers..."
cd /var/lib/coolify/source
./upgrade.sh

echo "Step 7: Creating installation marker..."
touch /var/lib/coolify/.installed

echo ""
echo "================================================"
echo "Coolify installation complete!"
echo ""
echo "Coolify should now be accessible at:"
echo "  http://localhost:8000"
echo ""
echo "To check container status: docker ps"
echo "To view logs: docker logs coolify"
echo ""
echo "The distrobox container will auto-start Coolify on subsequent boots."
echo "================================================"